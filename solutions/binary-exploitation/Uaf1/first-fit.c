#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(){
    char *A, *B, *C;

    fprintf(stderr, "glibc uses a first-fit algorithm to choose where it gets memory from.\n");
    fprintf(stderr, "If a chunk is free and large enough, malloc will use this chunk.\n");

    fprintf(stderr, "\n");

    fprintf(stderr, "Allocating 8 bytes to A.\n");
    A = malloc(8);

    fprintf(stderr, "Allocating 8 bytes to B.\n");
    B = malloc(8);

    fprintf(stderr, "\n");

    fprintf(stderr, "A: %p\n", A);
    fprintf(stderr, "B: %p\n", B);

    fprintf(stderr, "\n");

    fprintf(stderr, "We can copy data to A.\n");
    strcpy(A, "A");
    fprintf(stderr, "A: %p -> %s\n", A, A);

    fprintf(stderr, "\n");

    fprintf(stderr, "Now let's free chunk A.\n");
    free(A);

    fprintf(stderr, "\n");

    fprintf(stderr, "If we allocate less than or equal to 8 bytes, it well end up here: %p.\n", A);

    fprintf(stderr, "\n");

    fprintf(stderr, "Allocating 8 bytes to C.\n");
    C = malloc(8);
    fprintf(stderr, "C: %p\n", C);

    fprintf(stderr, "\n");

    fprintf(stderr, "If we check now, A and C point to the same piece of memory.\n");
    fprintf(stderr, "(%p == %p) == %s\n", A, C, A == C ? "True" : "False");

    fprintf(stderr, "\n");

    fprintf(stderr, "We can copy data to C.\n");
    strcpy(C, "C");
    fprintf(stderr, "C: %p -> %s\n", C, C);

    fprintf(stderr, "\n");

    fprintf(stderr, "If we reuse the first allocation, it now holds the data from the third allocation.\n");

    fprintf(stderr, "A: %p -> %s\n", A, A);
}
